angular.module("starter",["ngSanitize","ionic","ngMaterial","com.2fdevs.videogular"]).run(["$ionicPlatform","$rootScope","$state",function(e,s,t){e.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&(cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),cordova.plugins.Keyboard.disableScroll(!0)),window.StatusBar&&StatusBar.styleDefault(),firebase.auth().onAuthStateChanged(function(e){s.fbUser=firebase.auth().currentUser,null!=s.fbUser?(s.isLoggedIn=!0,console.log("loggedIN"),t.go("watch")):(s.isLoggedIn=!1,console.log("loggedOUT"),t.go("auth"))})})}]).config(["$stateProvider","$urlRouterProvider","$ionicConfigProvider",function(e,s,t){t.views.transition("none"),e.state("auth",{url:"/auth",templateUrl:"templates/auth.html",controller:"authCtrl"}).state("profile",{url:"/profile",templateUrl:"templates/profile.html",controller:"profileCtrl"}).state("watch",{url:"/watch",templateUrl:"templates/watch.html",controller:"watchCtrl"}).state("home",{url:"/home",templateUrl:"templates/home.html",controller:"homeCtrl"}),s.otherwise("/home")}]),angular.module("starter").controller("authCtrl",["$scope","$mdToast",function(e,s){e.showSignIn=!1,e.signUp=function(e){firebase.auth().createUserWithEmailAndPassword(e.email,e.password).then(function(s){firebase.database().ref("users/"+s.uid).update({name:e.name,username:e.username,status:"online",email:e.email}),console.log(e)}).catch(function(e){var t=e.code,n=e.message;s.show(s.simple().textContent("Error "+t+": "+n).hideDelay(3e3))})},e.signIn=function(e){firebase.auth().signInWithEmailAndPassword(e.email,e.password).then(function(e){firebase.database().ref("users/"+e.uid).update({status:"online"})}).catch(function(e){var t=e.code,n=e.message;s.show(s.simple().textContent("Error "+t+": "+n).hideDelay(3e3))}),console.log("sign in")},e.switch=function(){0==e.showSignIn?e.showSignIn=!0:1==e.showSignIn&&(e.showSignIn=!1),console.log(e.showSignIn)}}]),angular.module("starter").controller("homeCtrl",["$scope","$mdDialog","$state","$rootScope","$mdToast","$timeout",function(e,s,t,n,a,o){e.movies=[],e.getMovies=function(){firebase.database().ref("movies").once("value").then(function(s){s.forEach(function(s){firebase.storage().ref("images/"+s.val().poster).getDownloadURL().then(function(t){e.movies.push({uid:s.key,name:s.val().name,year:s.val().year,poster:t}),e.$applyAsync()})})})},e.movieChosen=function(e){console.log(e),s.show({locals:{movie:e,you:n.fbUser},clickOutsideToClose:!1,controllerAs:"ctrl",templateUrl:"templates/choose_friend.html",controller:i})};var i=function(e,n,i){e.movie=n,e.you=i,e.friends=[],e.friendIds=[],e.waiting=!1,e.cancel=function(){e.sessionId.length>0&&firebase.database().ref("sessions/"+e.sessionId).update({status:"canceled"},function(e){e||(s.cancel(),a.show(a.simple().textContent("Session Canceled!").hideDelay(3e3)))})},e.showFriends=function(){firebase.database().ref("users/"+e.you.uid+"/friends").once("value").then(function(s){s.forEach(function(s){e.friendIds.push(s.key)}),e.friendIds.forEach(function(s){firebase.database().ref("users/"+s).once("value").then(function(s){e.friends.push({uid:s.key,name:s.val().name,status:s.val().status}),e.$applyAsync()})})})},e.inviteFriend=function(n){e.waiting=!0,e.sessionId=firebase.database().ref().child("sessions").push().key,firebase.database().ref("sessions/"+e.sessionId).update({creator:e.you.uid,invitee:n.uid,movie:e.movie.uid,status:"pending"},function(a){if(a){var r=(a.code,a.message);e.statusMessage="Error: "+r}else e.statusMessage="Request Sent! Waiting on Response...",firebase.database().ref("sessions/"+e.sessionId).on("value",function(a){"pending"==a.val().status?e.statusMessage="Request Sent! Waiting on Response...":"rejected"==a.val().status?(e.statusMessage=n.name+" rejected your request...",o(function(){s.cancel()},3e3)):"accepted"==a.val().status&&(e.statusMessage=n.name+" accepted your request. You will be transfered to the video page in 3 seconds",firebase.database().ref("users/"+i.uid).update({watching:e.sessionId}),o(function(){s.cancel(),t.go("watch")},3e3)),e.$applyAsync()});e.$applyAsync()}),console.log(e.sessionId)}}}]),angular.module("starter").controller("navCtrl",["$scope","$rootScope","$state","$timeout","$mdToast",function(e,s,t,n,a){e.title="Synchronized Video Streaming",e.invites=[],e.inviteIds=[],e.signOut=function(){firebase.auth().signOut().then(function(){},function(e){})},e.start=function(){n(function(){e.watchInvites()},1e3)},e.watchInvites=function(){var t=firebase.database().ref("sessions").orderByChild("invitee").equalTo(s.fbUser.uid);t.on("value",function(s){e.invites.length=0,s.forEach(function(s){"pending"==s.val().status&&(e.invites.push(s.val()),e.inviteIds.push(s.key))}),console.log(e.invites),1==e.invites.length?firebase.database().ref("users/"+e.invites[0].creator).once("value").then(function(s){firebase.database().ref("movies/"+e.invites[0].movie).once("value").then(function(t){console.log(s.val());var n="You have an invite from "+s.val().name+" to watch "+t.val().name;a.show({locals:{title:n,button1:"Watch",button2:"Reject",invite:e.invites[0],id:e.inviteIds[0]},controller:o,templateUrl:"templates/toast_multi_action.html",hideDelay:!1})})}):a.hide()})};var o=function(e,s,a,o,i,r){e.title=s,e.button1=a,e.button2=o,e.reject=function(){firebase.database().ref("sessions/"+r).update({status:"rejected"})},e.watch=function(e){firebase.database().ref("sessions/"+r).update({status:"accepted"},function(e){if(e){e.code,e.message}else n(function(){firebase.database().ref("users/"+firebase.auth().currentUser.uid).update({watching:r}),t.go("watch")},3e3)})}};e.goToProfile=function(){t.go("profile")},e.ETgoHome=function(){t.go("home")}}]),angular.module("starter").controller("profileCtrl",["$scope","$mdToast","$state","$rootScope","$mdDialog",function(e,s,t,n,a){e.friendIds=[],e.friends=[],e.allUsers=[],e.getProfileInfo=function(){firebase.database().ref("users/"+n.fbUser.uid).once("value").then(function(s){e.user=s.val(),e.user.phone||(e.user.phone="")}),firebase.database().ref("users/"+n.fbUser.uid+"/friends").once("value").then(function(s){s.forEach(function(s){e.friendIds.push(s.key)}),e.friendIds.forEach(function(s){firebase.database().ref("users/"+s).once("value").then(function(s){e.friends.push({name:s.val().name,status:s.val().status}),e.$applyAsync()})})})},e.updateProfile=function(){firebase.database().ref("users/"+n.fbUser.uid).update({name:e.user.name,phone:e.user.phone,email:n.fbUser.email,username:e.user.username},function(e){var t;if(e){var n=e.code,a=e.message;t="Error "+n+": "+a}else t="Profile Updated";s.show(s.simple().textContent(t).hideDelay(3e3))})},e.searchForFriends=function(){e.allUsers.length=0,firebase.database().ref("users").once("value").then(function(s){s.forEach(function(s){s.key!=n.fbUser.uid&&(e.allUsers.push({name:s.val().name,username:s.val().username,uid:s.key}),e.$applyAsync())}),a.show({locals:{dataToPass:e.allUsers,you:n.fbUser},clickOutsideToClose:!0,controllerAs:"ctrl",templateUrl:"templates/add_friends.html",controller:o})})};var o=function(e,s,t){e.allUsers=s,e.fbUser=t,e.cancel=function(){a.cancel()},e.addFriend=function(s){var t=s.uid,n={};n[t]=1,firebase.database().ref("users/"+e.fbUser.uid+"/friends").update(n),a.cancel()}}}]),angular.module("starter").controller("watchCtrl",["$scope","$sce","$state","$rootScope","$mdToast","$timeout",function(e,s,t,n,a,o){e.getMovieInfo=function(){firebase.database().ref("users/"+n.fbUser.uid).once("value").then(function(t){e.sessionId=t.val().watching,firebase.database().ref("sessions/"+e.sessionId).once("value").then(function(t){e.sessionInfo=t.val(),firebase.database().ref("movies/"+e.sessionInfo.movie).once("value").then(function(t){firebase.storage().ref("images/"+t.val().poster).getDownloadURL().then(function(n){firebase.storage().ref("movies/"+t.val().movie).getDownloadURL().then(function(a){e.movie={uid:t.key,name:t.val().name,year:t.val().year,poster:n,movie:a},e.$applyAsync(),console.log(e.movie),e.config={preload:"none",sources:[{src:s.trustAsResourceUrl(e.movie.movie),type:"video/mp4"}]},e.$applyAsync()})})})})})},e.onUpdateState=function(e){console.log(e)},e.onUpdateTime=function(e,s){console.log(e+" "+s)}}]);