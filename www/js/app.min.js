angular.module("starter",["ngSanitize","ionic","ngMaterial","com.2fdevs.videogular"]).run(["$ionicPlatform","$rootScope","$state",function(e,s,a){e.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&(cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),cordova.plugins.Keyboard.disableScroll(!0)),window.StatusBar&&StatusBar.styleDefault(),firebase.auth().onAuthStateChanged(function(e){s.fbUser=firebase.auth().currentUser,null!=s.fbUser?(s.isLoggedIn=!0,console.log("loggedIN"),a.go("home")):(s.isLoggedIn=!1,console.log("loggedOUT"),a.go("auth"))})})}]).config(["$stateProvider","$urlRouterProvider","$ionicConfigProvider",function(e,s,a){a.views.transition("none"),e.state("auth",{url:"/auth",templateUrl:"templates/auth.html",controller:"authCtrl"}).state("profile",{url:"/profile",templateUrl:"templates/profile.html",controller:"profileCtrl"}).state("watch",{url:"/watch",templateUrl:"templates/watch.html",controller:"watchCtrl"}).state("home",{url:"/home",templateUrl:"templates/home.html",controller:"homeCtrl"}),s.otherwise("/home")}]),angular.module("starter").controller("authCtrl",["$scope","$mdToast",function(e,s){e.showSignIn=!1,e.signUp=function(e){firebase.auth().createUserWithEmailAndPassword(e.email,e.password).then(function(s){firebase.database().ref("users/"+s.uid).update({name:e.name,username:e.username,status:"online",email:e.email}),console.log(e)}).catch(function(e){var a=e.code,t=e.message;s.show(s.simple().textContent("Error "+a+": "+t).hideDelay(3e3))})},e.signIn=function(e){firebase.auth().signInWithEmailAndPassword(e.email,e.password).then(function(e){firebase.database().ref("users/"+e.uid).update({status:"online"})}).catch(function(e){var a=e.code,t=e.message;s.show(s.simple().textContent("Error "+a+": "+t).hideDelay(3e3))}),console.log("sign in")},e.switch=function(){0==e.showSignIn?e.showSignIn=!0:1==e.showSignIn&&(e.showSignIn=!1),console.log(e.showSignIn)}}]),angular.module("starter").controller("homeCtrl",["$scope","$mdDialog","$state","$rootScope","$mdToast","$timeout",function(e,s,a,t,n,o){e.movies=[],e.getMovies=function(){firebase.database().ref("movies").once("value").then(function(s){s.forEach(function(s){firebase.storage().ref("images/"+s.val().poster).getDownloadURL().then(function(a){e.movies.push({uid:s.key,name:s.val().name,year:s.val().year,poster:a}),e.$applyAsync()})})})},e.movieChosen=function(e){console.log(e),s.show({locals:{movie:e,you:t.fbUser},clickOutsideToClose:!1,controllerAs:"ctrl",templateUrl:"templates/choose_friend.html",controller:i})};var i=function(e,t,i){e.movie=t,e.you=i,e.friends=[],e.friendIds=[],e.waiting=!1,e.cancel=function(){e.sessionId.length>0&&firebase.database().ref("sessions/"+e.sessionId).update({status:"canceled"},function(e){e||(s.cancel(),n.show(n.simple().textContent("Session Canceled!").hideDelay(3e3)))})},e.showFriends=function(){firebase.database().ref("users/"+e.you.uid+"/friends").once("value").then(function(s){s.forEach(function(s){e.friendIds.push(s.key)}),e.friendIds.forEach(function(s){firebase.database().ref("users/"+s).once("value").then(function(s){e.friends.push({uid:s.key,name:s.val().name,status:s.val().status}),e.$applyAsync()})})})},e.inviteFriend=function(t){console.log(e.sessionId),e.waiting=!0,e.sessionId=firebase.database().ref().child("sessions").push().key,firebase.database().ref("sessions/"+e.sessionId).update({creator:e.you.uid,invitee:t.uid,movie:e.movie.uid,status:"pending"},function(n){if(n){var r=(n.code,n.message);e.statusMessage="Error: "+r}else e.statusMessage="Request Sent! Waiting on Response...",firebase.database().ref("sessions/"+e.sessionId).on("value",function(n){"pending"==n.val().status?e.statusMessage="Request Sent! Waiting on Response...":"rejected"==n.val().status?(e.statusMessage=t.name+" rejected your request...",o(function(){s.cancel()},3e3)):"accepted"==n.val().status&&(e.statusMessage=t.name+" accepted your request. You will be transfered to the video page in 3 seconds",firebase.database().ref("users/"+i.uid).update({watching:e.sessionId}),o(function(){s.cancel(),a.go("watch")},3e3)),e.$applyAsync()});e.$applyAsync()}),console.log(e.sessionId)}}}]),angular.module("starter").controller("navCtrl",["$scope","$rootScope","$state","$timeout","$mdToast",function(e,s,a,t,n){e.title="Synchronized Video Streaming",e.invites=[],e.inviteIds=[],e.signOut=function(){firebase.auth().signOut().then(function(){},function(e){})},e.start=function(){t(function(){e.watchInvites()},1e3)},e.watchInvites=function(){console.log("monitoring Invites");var a=firebase.database().ref("sessions").orderByChild("invitee").equalTo(s.fbUser.uid);a.on("value",function(s){e.invites.length=0,e.inviteIds.length=0,s.forEach(function(s){"pending"==s.val().status&&(e.invites.push(s.val()),e.inviteIds.push(s.key))}),1==e.invites.length?firebase.database().ref("users/"+e.invites[0].creator).once("value").then(function(s){firebase.database().ref("movies/"+e.invites[0].movie).once("value").then(function(a){var t="You have an invite from "+s.val().name+" to watch "+a.val().name;console.log(e.inviteIds[0]),n.show({locals:{title:t,button1:"Watch",button2:"Reject",invite:e.invites[0],id:e.inviteIds[0]},controller:o,templateUrl:"templates/toast_multi_action.html",hideDelay:!1})})}):n.hide()})};var o=function(e,s,n,o,i,r){e.title=s,e.button1=n,e.button2=o,console.log(r),e.reject=function(){firebase.database().ref("sessions/"+r).update({status:"rejected"})},e.watch=function(e){firebase.database().ref("sessions/"+r).update({status:"accepted"},function(e){if(e){e.code,e.message}else t(function(){firebase.database().ref("users/"+firebase.auth().currentUser.uid).update({watching:r}),a.go("watch")},3e3)})}};e.goToProfile=function(){a.go("profile")},e.ETgoHome=function(){a.go("home")}}]),angular.module("starter").controller("profileCtrl",["$scope","$mdToast","$state","$rootScope","$mdDialog",function(e,s,a,t,n){e.friendIds=[],e.friends=[],e.allUsers=[],e.getProfileInfo=function(){firebase.database().ref("users/"+t.fbUser.uid).once("value").then(function(s){e.user=s.val(),e.user.phone||(e.user.phone="")}),firebase.database().ref("users/"+t.fbUser.uid+"/friends").on("value",function(s){e.friendIds.length=0,e.friends.length=0,s.forEach(function(s){e.friendIds.push(s.key)}),e.friendIds.forEach(function(s){firebase.database().ref("users/"+s).once("value").then(function(s){e.friends.push({name:s.val().name,status:s.val().status}),e.$applyAsync()})})})},e.updateProfile=function(){firebase.database().ref("users/"+t.fbUser.uid).update({name:e.user.name,phone:e.user.phone,email:t.fbUser.email,username:e.user.username},function(e){var a;if(e){var t=e.code,n=e.message;a="Error "+t+": "+n}else a="Profile Updated";s.show(s.simple().textContent(a).hideDelay(3e3))})},e.searchForFriends=function(){e.allUsers.length=0,firebase.database().ref("users").once("value").then(function(s){s.forEach(function(s){s.key!=t.fbUser.uid&&(e.allUsers.push({name:s.val().name,username:s.val().username,uid:s.key}),e.$applyAsync())}),n.show({locals:{dataToPass:e.allUsers,you:t.fbUser},clickOutsideToClose:!0,controllerAs:"ctrl",templateUrl:"templates/add_friends.html",controller:o})})};var o=function(e,s,a){e.allUsers=s,e.fbUser=a,e.cancel=function(){n.cancel()},e.addFriend=function(s){var a=s.uid,t={};t[a]=1;var o={};o[e.fbUser.uid]=1,firebase.database().ref("users/"+e.fbUser.uid+"/friends").update(t),firebase.database().ref("users/"+a+"/friends").update(o),n.cancel()}}}]),angular.module("starter").controller("watchCtrl",["$scope","$sce","$state","$rootScope","$mdToast","$timeout",function(e,s,a,t,n,o){e.getMovieInfo=function(){firebase.database().ref("users/"+t.fbUser.uid).once("value").then(function(a){e.sessionId=a.val().watching,firebase.database().ref("sessions/"+e.sessionId).once("value").then(function(a){e.sessionInfo=a.val(),firebase.database().ref("movies/"+e.sessionInfo.movie).once("value").then(function(a){firebase.storage().ref("images/"+a.val().poster).getDownloadURL().then(function(t){firebase.storage().ref("movies/"+a.val().movie).getDownloadURL().then(function(n){e.movie={uid:a.key,name:a.val().name,year:a.val().year,poster:t,movie:n},e.$applyAsync(),e.config={preload:"none",sources:[{src:s.trustAsResourceUrl(e.movie.movie),type:"video/mp4"}]},e.$applyAsync()})})})})})};var i=null;e.onPlayerReady=function(s){i=s,o(function(){e.sessionInfo.creator==t.fbUser.uid?firebase.database().ref("sessions/"+e.sessionId).update({creator_status:"ready"}):e.sessionInfo.invitee==t.fbUser.uid&&firebase.database().ref("sessions/"+e.sessionId).update({invitee_status:"ready"});var s={status:"null"};firebase.database().ref("sessions/"+e.sessionId).on("value",function(e){"ready"==e.val().creator_status&&"ready"==e.val().invitee_status&&"null"==s.status&&(i.play(),console.log("START"),s.status="playing"),"paused"==e.val().status?(i.pause(),console.log("PAUSE"),s.status="paused"):"playing"==e.val().status&&(i.seekTime(e.val().pause_time,!1),i.play(),console.log("PLAY"),s.status="playing")})},2e3)};var r="play";e.onUpdateState=function(s){console.log("Current: "+s+" Old: "+r),"pause"==s&&"seeking"!=r?firebase.database().ref("sessions/"+e.sessionId).update({status:"paused",pause_time:e.currentTime}):"play"==s&&"seeking"!=r?firebase.database().ref("sessions/"+e.sessionId).update({status:"playing"}):"seeking"==r&&firebase.database().ref("sessions/"+e.sessionId).update({status:"playing",pause_time:e.currentTime}),r=s};var u=0;e.onUpdateTime=function(s,a){s-u>10?(console.log("YES"),u=s,i.seekTime(s,!1),r="seeking"):r="play",e.currentTime=s}}]);