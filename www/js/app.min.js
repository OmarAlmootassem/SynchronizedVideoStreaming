angular.module("starter",["ionic","ngMaterial"]).run(["$ionicPlatform","$rootScope","$state",function(e,n,t){e.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&(cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),cordova.plugins.Keyboard.disableScroll(!0)),window.StatusBar&&StatusBar.styleDefault(),firebase.auth().onAuthStateChanged(function(e){n.fbUser=firebase.auth().currentUser,null!=n.fbUser?(n.isLoggedIn=!0,console.log("loggedIN"),t.go("home")):(n.isLoggedIn=!1,console.log("loggedOUT"),t.go("auth"))})})}]).config(["$stateProvider","$urlRouterProvider","$ionicConfigProvider",function(e,n,t){t.views.transition("none"),e.state("auth",{url:"/auth",templateUrl:"templates/auth.html",controller:"authCtrl"}).state("profile",{url:"/profile",templateUrl:"templates/profile.html",controller:"profileCtrl"}).state("home",{url:"/home",templateUrl:"templates/home.html",controller:"homeCtrl"}),n.otherwise("/home")}]),angular.module("starter").controller("authCtrl",["$scope","$mdToast",function(e,n){e.showSignIn=!1,e.signUp=function(e){firebase.auth().createUserWithEmailAndPassword(e.email,e.password).then(function(n){firebase.database().ref("users/"+n.uid).update({name:e.name,username:e.username,status:"online",email:e.email}),console.log(e)}).catch(function(e){var t=e.code,o=e.message;n.show(n.simple().textContent("Error "+t+": "+o).hideDelay(3e3))})},e.signIn=function(e){firebase.auth().signInWithEmailAndPassword(e.email,e.password).then(function(e){firebase.database().ref("users/"+e.uid).update({status:"online"})}).catch(function(e){var t=e.code,o=e.message;n.show(n.simple().textContent("Error "+t+": "+o).hideDelay(3e3))}),console.log("sign in")},e.switch=function(){0==e.showSignIn?e.showSignIn=!0:1==e.showSignIn&&(e.showSignIn=!1),console.log(e.showSignIn)}}]),angular.module("starter").controller("homeCtrl",["$scope","$mdDialog","$state","$rootScope",function(e,n,t,o){e.movies=[],e.getMovies=function(){firebase.database().ref("movies").once("value").then(function(n){n.forEach(function(n){firebase.storage().ref("images/"+n.val().poster).getDownloadURL().then(function(t){e.movies.push({uid:n.key,name:n.val().name,year:n.val().year,poster:t}),e.$applyAsync()})})})},e.movieChosen=function(e){console.log(e),n.show({locals:{movie:e,you:o.fbUser},clickOutsideToClose:!0,controllerAs:"ctrl",templateUrl:"templates/choose_friend.html",controller:s})};var s=function(e,t,o){e.movie=t,e.you=o,e.friends=[],e.friendIds=[],e.cancel=function(){n.cancel()},e.showFriends=function(){firebase.database().ref("users/"+e.you.uid+"/friends").once("value").then(function(n){n.forEach(function(n){e.friendIds.push(n.key)}),e.friendIds.forEach(function(n){firebase.database().ref("users/"+n).once("value").then(function(n){e.friends.push({uid:n.key,name:n.val().name,status:n.val().status}),e.$applyAsync()})})})},e.inviteFriend=function(n){e.sessionId=firebase.database().ref().child("sessions").push().key,firebase.database().ref("sessions/"+e.sessionId).update({creator:e.you.uid,invitee:n.uid,movie:e.movie.uid,status:"pending"}),console.log(e.sessionId)}}}]),angular.module("starter").controller("navCtrl",["$scope","$rootScope","$state","$timeout","$mdToast",function(e,n,t,o,s){e.title="Synchronized Video Streaming",e.invites=[],e.inviteIds=[],e.signOut=function(){firebase.auth().signOut().then(function(){},function(e){})},e.start=function(){o(function(){e.watchInvites()},1e3)},e.watchInvites=function(){var t=firebase.database().ref("sessions").orderByChild("invitee").equalTo(n.fbUser.uid);t.on("value",function(n){e.invites.length=0,n.forEach(function(n){"pending"==n.val().status&&(e.invites.push(n.val()),e.inviteIds.push(n.key))}),console.log(e.invites),1==e.invites.length?firebase.database().ref("users/"+e.invites[0].creator).once("value").then(function(n){firebase.database().ref("movies/"+e.invites[0].movie).once("value").then(function(t){console.log(n.val());var o="You have an invite from "+n.val().name+" to watch "+t.val().name;s.show({locals:{title:o,button1:"Watch",button2:"Reject",invite:e.invites[0],id:e.inviteIds[0]},controller:a,templateUrl:"templates/toast_multi_action.html",hideDelay:!1})})}):s.hide()})};var a=function(e,n,t,o,s,a){e.title=n,e.button1=t,e.button2=o,e.reject=function(){firebase.database().ref("sessions/"+a).update({status:"rejected"})},e.watch=function(e){}};e.goToProfile=function(){t.go("profile")},e.ETgoHome=function(){t.go("home")}}]),angular.module("starter").controller("profileCtrl",["$scope","$mdToast","$state","$rootScope","$mdDialog",function(e,n,t,o,s){e.friendIds=[],e.friends=[],e.allUsers=[],e.getProfileInfo=function(){firebase.database().ref("users/"+o.fbUser.uid).once("value").then(function(n){e.user=n.val(),e.user.phone||(e.user.phone="")}),firebase.database().ref("users/"+o.fbUser.uid+"/friends").once("value").then(function(n){n.forEach(function(n){e.friendIds.push(n.key)}),e.friendIds.forEach(function(n){firebase.database().ref("users/"+n).once("value").then(function(n){e.friends.push({name:n.val().name,status:n.val().status}),e.$applyAsync()})})})},e.updateProfile=function(){firebase.database().ref("users/"+o.fbUser.uid).update({name:e.user.name,phone:e.user.phone,email:o.fbUser.email,username:e.user.username},function(e){var t;t=e?"Error "+errorCode+": "+errorMessage:"Profile Updated",n.show(n.simple().textContent(t).hideDelay(3e3))})},e.searchForFriends=function(){e.allUsers.length=0,firebase.database().ref("users").once("value").then(function(n){n.forEach(function(n){n.key!=o.fbUser.uid&&(e.allUsers.push({name:n.val().name,username:n.val().username,uid:n.key}),e.$applyAsync())}),s.show({locals:{dataToPass:e.allUsers,you:o.fbUser},clickOutsideToClose:!0,controllerAs:"ctrl",templateUrl:"templates/add_friends.html",controller:a})})};var a=function(e,n,t){e.allUsers=n,e.fbUser=t,e.cancel=function(){s.cancel()},e.addFriend=function(n){var t=n.uid,o={};o[t]=1,firebase.database().ref("users/"+e.fbUser.uid+"/friends").update(o),s.cancel()}}}]);